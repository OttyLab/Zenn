---
title: "Mapbox Newsletter WEEKLY TIPSã®è§£èª¬ -ã€Œã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ ã€"
emoji: "ğŸ”§"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Mapbox", "MapboxGLJS", "GIS", "JavaScript"]
published: false
publication_name: "mapbox_japan"
---

# ã¯ã˜ã‚ã«

ã“ã®è¨˜äº‹ã¯ã€å…ˆæ—¥é…ä¿¡ã•ã‚ŒãŸMapbox Newsletterã®WEEKLY TIPSã§ç´¹ä»‹ã•ã‚Œã¦ã„ãŸã€Œã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ ã€ã«ã¤ã„ã¦ã®è§£èª¬ã§ã™ã€‚ã“ã®ã‚µãƒ³ãƒ—ãƒ«ã§ã¯[`CustomLayerInterface`](https://docs.mapbox.com/mapbox-gl-js/api/properties/#customlayerinterface)ã®ä½¿ã„æ–¹ã‚’ç´¹ä»‹ã—ã¦ã„ã¾ã™ã€‚ã¾ãŸã€Newsletterã®è³¼èª­ã¯[ã“ã¡ã‚‰](https://www.mapbox.jp/blog?#:~:text=%E3%83%8B%E3%83%A5%E3%83%BC%E3%82%B9%E3%83%AC%E3%82%BF%E3%83%BC%E3%82%92%E8%B3%BC%E8%AA%AD)ã‹ã‚‰ãŠç”³ã—è¾¼ã¿ã„ãŸã ã‘ã¾ã™ã€‚

ä»¥ä¸‹ãŒæœ¬ã‚µãƒ³ãƒ—ãƒ«ã®ãƒ‡ãƒ¢ã§ã™ã€‚

@[codepen](https://codepen.io/OttyLab/pen/LYvGPvP)


# CustomLayerInterfaceã¨ã¯

åœ°ç†ç©ºé–“ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã™ã‚‹éš›ã€é€šå¸¸ã¯Mapbox GL JSã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆ[Symbolãƒ¬ã‚¤ãƒ¤ãƒ¼](https://docs.mapbox.com/style-spec/reference/layers/#symbol)ã€[Circleãƒ¬ã‚¤ãƒ¤ãƒ¼](https://docs.mapbox.com/style-spec/reference/layers/#circle)ç­‰ï¼‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ãã‚Œã«åŠ ãˆã¦ã€Mapbox GL JSã§ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªç”±ã«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãã®éš›ã«ä½¿ç”¨ã™ã‚‹ã®ãŒ[`CustomLayerInterface`](https://docs.mapbox.com/mapbox-gl-js/api/properties/#customlayerinterface)ã§ã™ã€‚

Mapbox GL JSã¯Web GLã‚’ä½¿ç”¨ã—ã¦åœ°å›³ã‚’æç”»ã—ã¾ã™ãŒã€`CustomLayerInterface`ã§ã¯Web GLã‚’ç›´æ¥æ“ä½œã™ã‚‹ã“ã¨ã§æ§˜ã€…ãªãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¡¨ç¾ã—ã¾ã™ã€‚ãŸã¨ãˆã°[deck.gl](https://deck.gl/)ã¯Mapbox GL JSã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹[æ§˜ã€…ãªãƒ¬ã‚¤ãƒ¤ãƒ¼](https://deck.gl/docs/api-reference/layers)ãŒã‚ã‚Šã¾ã™ãŒã€[`CustomLayerInterface`ã‚’ç”¨ã„ã¦å®Ÿç¾](https://github.com/visgl/deck.gl/blob/v8.9.35/modules/mapbox/src/mapbox-layer.ts#L11)ã—ã¦ã„ã¾ã™ã€‚

è‡ªä½œãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½œã‚‹éš›ã«ã¯`CustomLayerInterface`ã‚’ç¶™æ‰¿ã—ãŸï¼ˆã¾ãŸã¯ã€åŒã˜ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒã¤ï¼‰ã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã—ã¾ã™ã€‚`onAdd`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆæ™‚ã«ã¾ã¨ã‚ã¦è¡Œã†Web GLã®åˆæœŸåŒ–å‡¦ç†ã‚’è¨˜è¿°ã—ã€`render`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã¯æç”»ã®éš›ã«å®Ÿè¡Œã™ã‚‹Web GLã®ã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¿°ã—ã¾ã™ã€‚


# ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèª

ã¾ãšExamplesã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã«è¡Œãã¾ã—ã‚‡ã†ã€‚

æ—¥æœ¬èªã‚µã‚¤ãƒˆ
@[card](https://docs.mapbox.com/jp/mapbox-gl-js/example/custom-style-layer/)

è‹±èªã‚µã‚¤ãƒˆ
@[card](https://docs.mapbox.com/mapbox-gl-js/example/custom-style-layer/)

åŸºæœ¬çš„ã«åŒã˜ã‚³ãƒ¼ãƒ‰ã§ã™ãŒã€è‹±èªç‰ˆã¯ã‚¹ã‚¿ã‚¤ãƒ«ãŒMapbox Light v11ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã®ã§ã“ã¡ã‚‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚Mapbox Light v10ã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãŒWebãƒ¡ãƒ«ã‚«ãƒˆãƒ«ã§ã‚ã‚‹ã®ã«å¯¾ã—ã€Mapbox Light v11ã§ã¯Globeï¼ˆ3Dè¡¨ç¤ºã•ã‚ŒãŸåœ°çƒï¼‰ãªã®ã§ã€å°è±¡ãŒã‹ãªã‚Šç•°ãªã‚Šã¾ã™ã€‚ã¾ãŸã€è‹±èªç‰ˆã¯Mapbox GL JS v3ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

## HTML

ã¾ãšHTMLã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

ä»¥ä¸‹ã¯åœ°å›³ã‚’è¡¨ç¤ºã™ã‚‹ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã§ã™ã€‚

```HTML
<div id="map"></div>
```

## Mapã®ä½œæˆ

JavaScriptã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¯ã„ã¤ã‚‚é€šã‚Šã€Mapã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚`container`ã§åœ°å›³ã‚’è¡¨ç¤ºã™ã‚‹HTMLã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã®idã‚’æŒ‡å®šã—ã¾ã™ã€‚

```JavaScript
const map = new mapboxgl.Map({
  container: 'map',
  zoom: 3,
  center: [7.5, 58],
  // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
  style: 'mapbox://styles/mapbox/light-v11',
  antialias: true, // create the gl context with MSAA antialiasing, so custom layers are antialiased
  projection: 'mercator'
});
```

## ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä½œæˆ
é€”ä¸­ã‚’é£›ã°ã—ã¦æœ€å¾Œã®éƒ¨åˆ†ã‚’ç¢ºèªã—ã¾ã™ã€‚`highlightLayer`ã¯è‡ªä½œãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å®šç¾©ã‚’å«ã‚€ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã™ã€‚Symbolãƒ¬ã‚¤ãƒ¤ãƒ¼ç­‰ã¨åŒã˜æ§˜ã«[Map#addLayer](https://docs.mapbox.com/mapbox-gl-js/api/map#map#addlayer)ãƒ¡ã‚½ãƒƒãƒ‰ã§ä½œæˆã—ã¾ã™ã€‚ç¬¬2å¼•æ•°ã«`building`ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ã®ã§ã€è‡ªä½œãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã“ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä¸‹ã«æç”»ã•ã‚Œã¾ã™ã€‚

```JavaScript
map.on('load', () => {
  map.addLayer(highlightLayer, 'building');
});
```

æ‹¡å¤§ã—ã¦ã¿ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ“ãƒ«ã®ä¸‹ã«è‡ªä½œãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæç”»ã•ã‚Œã¦ã„ã‚‹ã®ãŒã‚ã‹ã‚Šã¾ã™ã€‚
![buildingã®ä¸‹](/images/articles/7a48c93b0d2444/under_building.png)

## è‡ªä½œãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å®šç¾©
ãã‚Œã§ã¯`highlightLayer`ã®ä¸­èº«ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

`id`ã¨`type`ã‚’æŒ‡å®šã™ã‚‹ã®ã¯ä»–ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨åŒã˜ã§ã™ã€‚`CustomLayerInterface`ã®ã¨ãã¯`custom`ã‚’æŒ‡å®šã—ã¾ã™ã€‚

```JavaScript
id: 'highlight',
type: 'custom',
```

### onAdd
ä»¥ä¸‹ã®`onAdd`ã®ä¸­èº«ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

```JavaScript
onAdd: function (map, gl) {
  ...
},
```

ã¾ãšã€é ‚ç‚¹ã‚·ã‚§ãƒ¼ãƒ€ã¨ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆã‚·ã‚§ãƒ¼ãƒ€ã®ã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚é ‚ç‚¹ã‚·ã‚§ãƒ¼ãƒ€ã®`u_matrix`ã¯ã‚«ãƒ¡ãƒ©è¡Œåˆ—ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚ã¾ãŸã€ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆã‚·ã‚§ãƒ¼ãƒ€ã¯èµ¤è‰²ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚
```JavaScript
// create GLSL source for vertex shader
const vertexSource = `
  uniform mat4 u_matrix;
  attribute vec2 a_pos;
  void main() {
    gl_Position = u_matrix * vec4(a_pos, 0.0, 1.0);
  }`;

// create GLSL source for fragment shader
const fragmentSource = `
  void main() {
    gl_FragColor = vec4(1.0, 0.0, 0.0, 0.5);
  }`;
```

å„ã‚·ã‚§ãƒ¼ãƒ€ã‹ã‚‰ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚
```JavaScript
// create a vertex shader
const vertexShader = gl.createShader(gl.VERTEX_SHADER);
gl.shaderSource(vertexShader, vertexSource);
gl.compileShader(vertexShader);

// create a fragment shader
const fragmentShader = gl.createShader(gl.FRAGMENT_SHADER);
gl.shaderSource(fragmentShader, fragmentSource);
gl.compileShader(fragmentShader);

// link the two shaders into a WebGL program
this.program = gl.createProgram();
gl.attachShader(this.program, vertexShader);
gl.attachShader(this.program, fragmentShader);
gl.linkProgram(this.program);
```

é ‚ç‚¹ã‚·ã‚§ãƒ¼ãƒ€ã§ä½¿ç”¨ã—ã¦ã„ã‚‹`a_pos`ã¨ã„ã†å±æ€§ã‚’å–å¾—ã—ã€`this.aPos`ã«ä¿å­˜ã—ã¾ã™ã€‚å¾Œã»ã©`render`ã®å†…éƒ¨ã§ä½¿ç”¨ã—ã¾ã™ã€‚
```JavaScript
this.aPos = gl.getAttribLocation(this.program, 'a_pos');
```

[`MercatorCoordinate.fromLngLat`](https://docs.mapbox.com/mapbox-gl-js/api/geography/#mercatorcoordinate.fromlnglat)ã§è»½åº¦ãƒ»ç·¯åº¦ã‹ã‚‰Web GLä¸Šã§ã®é ‚ç‚¹åº§æ¨™ã‚’è¨ˆç®—ã—ã¦ã„ã¾ã™ã€‚

```JavaScript
// define vertices of the triangle to be rendered in the custom style layer
const helsinki = mapboxgl.MercatorCoordinate.fromLngLat({
  lng: 25.004,
  lat: 60.239
});
const berlin = mapboxgl.MercatorCoordinate.fromLngLat({
  lng: 13.403,
  lat: 52.562
});
const kyiv = mapboxgl.MercatorCoordinate.fromLngLat({
  lng: 30.498,
  lat: 50.541
});
```

ãƒãƒƒãƒ•ã‚¡ã‚’ä½œæˆã—ã€å…ˆç¨‹ã®é ‚ç‚¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã„ã¾ã™ã€‚
```JavaScript
// create and initialize a WebGLBuffer to store vertex and color data
this.buffer = gl.createBuffer();
gl.bindBuffer(gl.ARRAY_BUFFER, this.buffer);
gl.bufferData(
  gl.ARRAY_BUFFER,
  new Float32Array([
    helsinki.x,
    helsinki.y,
    berlin.x,
    berlin.y,
    kyiv.x,
    kyiv.y
  ]),
  gl.STATIC_DRAW
);
```

### render
ä»¥ä¸‹ã®`render`ã®ä¸­èº«ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

```JavaScript
render: function (gl, matrix) {
  ...
}
```

å®Ÿè¡Œã™ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¨ã—ã¦å…ˆã»ã©ä½œæˆã—ãŸãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’æŒ‡å®šã—ã¾ã™ã€‚
```JavaScript
gl.useProgram(this.program);
```

ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ `u_matrix`ã«`render`ã®å¼•æ•°ã®`matrix`ã‚’è¨­å®šã—ã¾ã™ã€‚ã“ã‚Œã¯é ‚ç‚¹ã‚·ã‚§ãƒ¼ãƒ€ã§ä½¿ç”¨ã•ã‚Œã‚‹ã‚«ãƒ¡ãƒ©è¡Œåˆ—ã§ã™ã€‚
```JavaScript
gl.uniformMatrix4fv(
    gl.getUniformLocation(this.program, 'u_matrix'),
    false,
    matrix
);

```

é ‚ç‚¹åº§æ¨™ã‚’æ ¼ç´ã—ãŸãƒãƒƒãƒ•ã‚¡ãƒ¼ã®è¨­å®šã§ã™ã€‚
```JavaScript
gl.bindBuffer(gl.ARRAY_BUFFER, this.buffer);
gl.enableVertexAttribArray(this.aPos);
gl.vertexAttribPointer(this.aPos, 2, gl.FLOAT, false, 0, 0);
```

ãƒ–ãƒ¬ãƒ³ãƒ‰ã®è¨­å®šã§ã™ã€‚ã“ã®è¨­å®šã‚’ã™ã‚‹ã“ã¨ã§ã€è‡ªä½œãƒ¬ã‚¤ãƒ¤ãƒ¼ã«éš ã‚Œã¦ã„ã‚‹éƒ¨åˆ†ãŒè‡ªç„¶ãªé›°å›²æ°—ã§è¡¨ç¾ã•ã‚Œã¾ã™ã€‚
```JavaScript
gl.enable(gl.BLEND);
gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
```

æœ€å¾Œã«æç”»ã‚’æŒ‡ç¤ºã—ã¾ã™ã€‚
```JavaScript
gl.drawArrays(gl.TRIANGLE_STRIP, 0, 3);
```

# ã¾ã¨ã‚
`CustomLayerInterface`ã‚’ä½¿ç”¨ã™ã‚‹ã¨Web GLã‚’ç›´æ¥åˆ¶å¾¡ã§ãã€ä»»æ„ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½œæˆã§ãã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚
