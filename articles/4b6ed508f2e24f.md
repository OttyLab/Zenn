---
title: "ã€ŒSoftware Design 2023å¹´12æœˆå· ä½ç½®æƒ…å ±ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã®ã™ã™ã‚ ç¬¬5å›ã€ã‚’Mapbox GL JSã§å®Ÿè£…ã—ã¦ã¿ã‚‹"
emoji: "ğŸ°"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Mapbox", "MapboxGLJS", "GIS", "JavaScript", "SoftwareDesign"]
published: false
publication_name: "mapbox_japan"
---

# ã¯ã˜ã‚ã«

[å‰å›](https://zenn.dev/mapbox_japan/articles/0cf786c002a7a5)ã«å¼•ãç¶šãã€Software Designã§é€£è¼‰ä¸­ã®ã€Œä½ç½®æƒ…å ±ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã®ã™ã™ã‚ã€ã‚’Mapbox GL JSã§å®Ÿè£…ã—ã¦ã¿ã¾ã™ã€‚


# åœ°å›³ã®è¡¨ç¤º
## ç’°å¢ƒæ§‹ç¯‰

ç´™é¢ã®é€šã‚Šã€Viteã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```zsh
% npm create vite@latest webmap
Need to install the following packages:
  create-vite@5.0.0
Ok to proceed? (y) y
âœ” Select a framework: â€º Vanilla
âœ” Select a variant: â€º TypeScript

Scaffolding project in /Users/yochi/Downloads/20231130/webmap...

Done. Now run:

  cd webmap
  npm install
  npm run dev
```

ä¸Šè¨˜ã§æŒ‡ç¤ºã•ã‚ŒãŸé€šã‚Šã‚³ãƒãƒ³ãƒ‰ã‚’æ‰“ã£ã¦ã„ãã¾ã™ã€‚

```zsh
% cd webmap
% npm install
% npm run dev
```

## Mapbox GL JSã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§Mapbox GL JSã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
```zsh
% npm install mapbox-gl
```

MapbLibre GL JSã¯TypeScriptã§è¨˜è¿°ã•ã‚Œã¦ã„ã‚‹ãã†ã§ã™ãŒã€æ®‹å¿µãªãŒã‚‰Mapbox GL JSã¯JavaScriptã§ã™ã€‚ãã“ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
```zsh
% npm install @types/mapbox-gl
```

## åœ°å›³ã®è¡¨ç¤º
HTMLã¯ç´™é¢ã®é€šã‚Šè¨˜è¿°ã—ã¾ã™ã€‚

```html
<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mapbox GL JSã§Webåœ°å›³</title>
  </head>
  <body style="margin: 0;">
    <div id="map" style="height: 100vh;"></div>
    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
```

JavaScriptã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚é•ã„ã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®åç§°ã¨ã€`Map`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã®éš›ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã—ã¦`accessToken`ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã™ã€‚

```JavaScript
import { Map } from 'mapbox-gl';
import 'mapbox-gl/dist/mapbox-gl.css'

const map = new Map({
    accessToken:'YOUR_PUBLIC_TOKEN',
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [143.95, 43.65],
    zoom: 6,
});
```

# ãƒã‚¤ãƒ³ãƒˆã‚’è¡¨ç¤º
## ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
ä»¥ä¸‹ã‹ã‚‰Hokkaidoã®.shp.zipã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

https://download.geofabrik.de/asia/japan.html

ç´™é¢ã®é€šã‚ŠGeoJSONã«å¤‰æ›ã—ã¾ã™ã€‚

```zsh
% ogr2ogr -f GeoJSON poi.json gis_osm_pois_free_1.shp
```

## ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤º
å¤‰æ›ã—ãŸGeoJSONã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ç´™é¢ã§ã¯`Map`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã®éš›ã«ç›´æ¥Styleã¨ã—ã¦è¨˜è¿°ã—ã¦ã„ã¾ã—ãŸã€‚ä»Šå›ã€`streets-v12`ã‚’ä½¿ã£ã¦ã„ã‚‹éƒ½åˆä¸Šã€`Map#addSource`ã€`Map#addLayer`ã§è¿½åŠ ã—ã¾ã™ã€‚ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```JavaScript
import { Map } from 'mapbox-gl';
import 'mapbox-gl/dist/mapbox-gl.css'
import poiGeojson from './poi.json';

const map = new Map({
    accessToken:'YOUR_PUBLIC_TOKEN',
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [143.95, 43.65],
    zoom: 6,
});

map.on('style.load', () => {
    map.addSource('poi', {
        type: 'geojson',
        data: poiGeojson,
    });

    map.addLayer({
        id: 'poi',
        type: 'circle',
        source: 'poi',
        paint: {
            'circle-radius': 6,
            'circle-color': '#ff0000',
        },
    });
});
```

## ã‚¯ãƒ©ã‚¹ã‚¿åŒ–
## ã‚¯ãƒ©ã‚¹ã‚¿ã®ä½¿ã„æ–¹

ã‚¯ãƒ©ã‚¹ã‚¿ã¯è¤‡æ•°ã®Pointãƒ‡ãƒ¼ã‚¿ã‚’é›†ç´„ã—ã€ä¸€ã¤ã®Pointãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ã‚½ãƒ¼ã‚¹ã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚ãã®ãŸã‚ã€ã¾ãš`addSource`ã§ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã§ã‚ã‚‹ã“ã¨ã‚’å®£è¨€ã—ã¾ã™ã€‚
```JavaScript
map.addSource('poi', {
    type: 'geojson',
    data: poiGeojson as any,
    cluster: true, //ã“ã“
    clusterMaxZoom: 15,
});
```

ã‚ã¨ã¯ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦å­˜åœ¨ã—ã¦ã„ã‚‹ã“ã¨ã«ãªã‚‹ã®ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã‚½ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§è¡¨ç¤ºã§ãã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ãŒå‚è€ƒã«ãªã‚Šã¾ã™ã€‚
https://docs.mapbox.com/mapbox-gl-js/example/cluster/

## ã‚³ãƒ¼ãƒ‰
ã‚¯ãƒ©ã‚¹ã‚¿åŒ–ã‚‚åŸºæœ¬çš„ã«MapLibre GL JSã¨åŒã˜ã‚³ãƒ¼ãƒ‰ã§å‹•ãã¾ã™ã€‚

```JavaScript
import { Map } from 'mapbox-gl';
import 'mapbox-gl/dist/mapbox-gl.css'
import poiGeojson from './poi.json';

const map = new Map({
    accessToken:'YOUR_PUBLIC_TOKEN',
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [143.95, 43.65],
    zoom: 6,
});

map.on('style.load', () => {
    map.addSource('poi', {
        type: 'geojson',
        data: poiGeojson as any,
        cluster: true,
        clusterMaxZoom: 15,
    });

    map.addLayer({
        id: 'poi',
        type: 'circle',
        source: 'poi',
        paint: {
            'circle-radius': [
                'interpolate',
                ['linear'],
                ['get', 'point_count'],
                1, 10,
                500, 50,
                2000, 70,
            ],
            'circle-color': '#aaaaff',
            'circle-stroke-color': '#000000',
            'circle-stroke-width': 1,
            'circle-opacity': 0.8,
        },
    });
});
```

ã“ã“ã§ã¯ä»¥ä¸‹ã®`circle-radius`ã®Expressionsã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

```JavaScript
'circle-radius': [
    'interpolate',
    ['linear'],
    ['get', 'point_count'],
    1, 10,
    500, 50,
    2000, 70,
],
```

[`interpolate`](https://docs.mapbox.com/style-spec/reference/expressions/#interpolate)ã¯è£œé–“ã§ã™ã€‚ç¬¬1å¼•æ•°ã¯è£œé–“ã®æ–¹æ³•ã§ã™ã€‚ã“ã“ã§ã¯`linear`ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã®ã§ç·šå½¢è£œé–“ã§ã™ã€‚ç¬¬2å¼•æ•°ãŒå…¥åŠ›å€¤ã§ã™ã€‚ã“ã“ã§ã¯[`get`](https://docs.mapbox.com/style-spec/reference/expressions/#get)ã‚’ä½¿ç”¨ã—ã¦`point_count`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å€¤ã‚’å–å¾—ã—å…¥åŠ›å€¤ã¨ã—ã¦ä½¿ç”¨ã—ã¾ã™ã€‚ãã‚Œä»¥é™ã®å¼•æ•°ã¯`å…¥åŠ›å€¤,å‡ºåŠ›ã™ã‚‹å€¤`ã®ãƒšã‚¢ã¨ãªã‚Šã¾ã™ã€‚ä¾‹ãˆã°`1,10`ã¯`point_count`ãŒ`1`ã®æ™‚ã€å††ã®åŠå¾„ãŒ`10`ã¨ãªã‚Šã¾ã™ã€‚ã¾ãŸã€ç·šå½¢è£œé–“ã¨ãªã‚‹ã®ã§ã€`point_count`ã®å€¤ãŒ`1`ã€œ`500`ã®æ™‚ã€åŠå¾„ã¯`10`ã€œ`50`ã®é–“ã§ç·šå½¢è£œé–“ã•ã‚Œã¾ã™ã€‚

çµæœã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

https://sd202312.netlify.app/cluster


# å»ºç‰©ãƒ‡ãƒ¼ã‚¿ã€é“è·¯ãƒ©ã‚¤ãƒ³ã‚’ãƒ™ã‚¯ã‚¿ãƒ¼ã‚¿ã‚¤ãƒ«ã«å¤‰æ›
ç´™é¢ã§ã¯å»ºç‰©ãƒãƒªã‚´ãƒ³ã‚’è¡¨ç¤ºã—ã¦ã‹ã‚‰é“è·¯ãƒ©ã‚¤ãƒ³ã‚‚è¡¨ç¤ºã™ã‚‹ã¨ã„ã†ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¸ã‚“ã§ã„ã¾ã™ãŒã€ã“ã“ã§ã¯ã¾ã¨ã‚ã¦ã‚„ã£ã¦ã—ã¾ã„ã¾ã™ã€‚[`GeoJSONSeq`](https://gdal.org/drivers/vector/geojsonseq.html)ã¨æŒ‡å®šã™ã‚‹ã¨å‡ºåŠ›å½¢å¼ãŒ[ndjson]('https://ndjson.org/')ã«ãªã‚Šã¾ã™ã€‚ndjsonã§ã¯1è¡Œ1ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

```zsh
% ogr2ogr -f GeoJSONSeq building.jsonl gis_osm_buildings_a_free_1.shp
% ogr2ogr -f GeoJSONSeq road.jsonl gis_osm_roads_free_1.shp
```

æ¬¡ã«tippecanoeã§ã‚¿ã‚¤ãƒ«ã‚»ãƒƒãƒˆã«å¤‰æ›ã—ã¾ã™ã€‚ä¸¦åˆ—å‡¦ç†ã‚’è¡Œã†[`-Pã‚ªãƒ—ã‚·ãƒ§ãƒ³`](https://github.com/felt/tippecanoe#parallel-processing-of-input)ãŒline-delimited JSON (ndjson)ã®ã¨ãã®ã¿ä½¿ç”¨å¯èƒ½ã§ã™ã€‚ãã®ãŸã‚ã€å…ˆã»ã©`GeoJSONSeq`ã‚’æŒ‡å®šã—ã¾ã—ãŸã€‚ã¾ãŸã€[`-M`ã‚ªãƒ—ã‚·ãƒ§ãƒ³](https://github.com/felt/tippecanoe#setting-or-disabling-tile-size-limits)ã¯ä¸€ã¤ã®ã‚¿ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®ä¸Šé™å€¤ã§ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯500KBãªã®ã§ã€5MBã¯ç›¸å½“å¤§ãã„å€¤ã§ã™ã€‚

```zsh
% tippecanoe -e tiles -pC -pf -M 5000000 -P -L road:road.jsonl -L building:building.jsonl
```

# å»ºç‰©ãƒ‡ãƒ¼ã‚¿ã€é“è·¯ãƒ©ã‚¤ãƒ³ã®è¡¨ç¤º

Mapbox GL JSã«é–¢ã™ã‚‹éƒ¨åˆ†ãŠã‚ˆã³`style.load`ã«é–¢ã™ã‚‹éƒ¨åˆ†ä»¥å¤–ã¯ç´™é¢ã®é€šã‚Šã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã¾ã™ã€‚[`fill-extrusion`](https://docs.mapbox.com/style-spec/reference/layers/#fill-extrusion)ã¯é«˜ã•æƒ…å ±ã‚’ç”¨ã„ã¦å»ºç‰©ç­‰ã‚’3Dè¡¨ç¤ºã§ãã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã™ã€‚

```JavaScript
import { Map } from 'mapbox-gl';
import 'mapbox-gl/dist/mapbox-gl.css'
import poiGeojson from './poi.json';

const map = new Map({
    accessToken:'YOUR_PUBLIC_TOKEN',
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [143.95, 43.65],
    zoom: 6,
});

map.on('style.load', () => {
    map.addSource('vectortile', {
        type: 'vector',
        tiles: [
            `${window.location.origin}/tiles/{z}/{x}/{y}.pbf`,
        ],
        maxzoom: 14,
    });

    map.addLayer({
        id: 'building2',
        type: 'fill-extrusion',
        source: 'vectortile',
        'source-layer': 'building',
        paint: {
            'fill-extrusion-color': '#a66',
            'fill-extrusion-height': 10,
            'fill-extrusion-opacity': 0.6,
        },
   });

    map.addLayer({
        id: 'road2',
        type: 'line',
        source: 'vectortile',
        'source-layer': 'road',
        paint: {
            'line-color': [
                'case',
                ['==', ['get', 'fclass'], 'primary'], '#f00',
                ['==', ['get', 'fclass'], 'secondary'], '#ff0',
                ['==', ['get', 'fclass'], 'teriary'], '#0a0',
                ['==', ['get', 'fclass'], 'residential'], '#00f',
                '#000',
            ],
            'line-width': [
                'case',
                ['==', ['get', 'fclass'], 'primary'], 10,
                ['==', ['get', 'fclass'], 'secondary'], 8,
                ['==', ['get', 'fclass'], 'teriary'], 6,
                ['==', ['get', 'fclass'], 'residential'], 4,
                2,
            ],
        },
   });
});
```

çµæœã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

https://sd202312.netlify.app/building


# ã¾ã¨ã‚
ä»Šå›ã‚‚ã€MapLibre GL JSã¨ã»ã¨ã‚“ã©åŒã˜ã‚³ãƒ¼ãƒ‰ã§å‹•ãã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚


# Appendix A. ç¬¬4å›ã‚’ã‚¯ãƒ©ã‚¹ã‚¿åŒ–
ã›ã£ã‹ããªã®ã§ç¬¬4å›ã§ä½œæˆã—ãŸã‚‚ã®ã‚’ã‚¯ãƒ©ã‚¹ã‚¿åŒ–ã—ã¾ã—ãŸã€‚

@[codepen](https://codepen.io/OttyLab/pen/YzBMNMz)

è¤‡æ•°ç¨®é¡ã®ãƒ‡ãƒ¼ã‚¿(`school_type`)ãŒä¸€ã¤ã®GeoJSONã«å«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ã€`fetch`ã§GeoJSONã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‹ã‚‰`addSource`ã®éš›ã«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦ã„ã¾ã™ã€‚

```JavaScript
    const response = await fetch("https://gist.githubusercontent.com/OttyLab/f4526ddf444b8f4add296ad337bcc601/raw/58732f3b6b3479d2f50b015fc1167dcfaeb238fe/merge.geojson");
    const data = await response.json();

    schools.forEach(s => {
      map.addSource(`source_point_${s.type}`, {
        type: "geojson",
        data,
        filter: ["==", ["get", "school_type"], s.type],
        cluster: true,
        clusterMaxZoom: 15
      });
```


# Appendix B. tippecanoe

tippecanoeã¯ã‚‚ã¨ã‚‚ã¨[Mapboxã§é–‹ç™º](https://github.com/mapbox/tippecanoe)ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚ã—ã‹ã—ã€[ãƒ¡ã‚¤ãƒ³ã§é–‹ç™ºã‚’è¡Œã£ã¦ã„ãŸã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãŒè»¢è·ã—ãŸ](https://felt.com/blog/erica-fischer-tippecanoe-at-felt)ãŸã‚ã€ç¾åœ¨ã¯[Feltã§é–‹ç™º](https://github.com/felt/tippecanoe)ãŒç¶™ç¶šã•ã‚Œã¦ã„ã¾ã™ã€‚brewã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸå ´åˆã€feltã®æ–¹ï¼ˆã¤ã¾ã‚Šæœ€æ–°ï¼‰ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚


# Appendix C. consoleã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚¨ãƒ©ãƒ¼
Vite v5 + Mapbox GL JSã§ã¯consoleã«ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

```
Uncaught Error: Unimplemented type: 4
    at lm.skip (3519c730-a3f6-4996-9e1f-531464dd0686:9404:21)
    at lm.readFields (3519c730-a3f6-4996-9e1f-531464dd0686:9266:75)
    at new Gf.VectorTile (3519c730-a3f6-4996-9e1f-531464dd0686:9131:28)
    at 3519c730-a3f6-4996-9e1f-531464dd0686:27067:145
    at Object.fn (3519c730-a3f6-4996-9e1f-531464dd0686:17358:17)
    at fw.process (3519c730-a3f6-4996-9e1f-531464dd0686:16857:18)
    at MessageChannel._channel.port2.onmessage (3519c730-a3f6-4996-9e1f-531464dd0686:16812:45)
```

ã“ã‚Œã¯å­˜åœ¨ã—ãªã„ã‚¿ã‚¤ãƒ«ã‚’å–å¾—ã—ã‚ˆã†ã¨ã—ãŸéš›ã«ã€ViteãŒ404ã‚¨ãƒ©ãƒ¼ã§ã¯ãªãindex.htmlã‚’è¿”ã—ã¦ãã‚‹ã“ã¨ã«èµ·å› ã—ã¦ã„ã¾ã™ã€‚Mapbox GL JSã¯ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒ™ã‚¯ã‚¿ãƒ¼ã‚¿ã‚¤ãƒ«ã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹ã—ã‚ˆã†ã¨ã—ã¦ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚ã¡ãªã¿ã«ã€Vite v4ã§ã¯404ã‚¨ãƒ©ãƒ¼ã¨ãªã‚Šã¾ã™ã€‚MapLibre GL JSã§ã¯ã‚¨ãƒ©ãƒ¼ã¯è¡¨ç¤ºã•ã‚Œãªã„ã®ã§ã€ä¾‹å¤–å‡¦ç†ã‚’è¡Œã£ã¦ã„ã‚‹ã¨äºˆæƒ³ã•ã‚Œã¾ã™ã€‚
