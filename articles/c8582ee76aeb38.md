---
title: "Isochrone APIã®æ–°æ©Ÿèƒ½ã€depart_atã‚’è©¦ã—ã¦ã¿ã‚‹"
emoji: "ğŸš™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Mapbox", "MapboxGLJS", "GIS", "JavaScript", "isochrone"]
published: true
publication_name: "mapbox_japan"
---

# ã¯ã˜ã‚ã«

Mapboxã¯ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã«é–¢ã™ã‚‹APIã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚ãã®ä¸­ã®[Isochrone API](https://docs.mapbox.com/api/navigation/isochrone/)ã§`depart_at`æ©Ÿèƒ½ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚ã“ã®è¨˜äº‹ã§ã¯ã“ã®æ–°æ©Ÿèƒ½ã‚’è©¦ã—ã¦ã¿ã¾ã™ã€‚ãªãŠã€`depart_at`ã¨ä½¿ç”¨ã™ã‚‹ãŸã‚ã«ã¯[ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¸ã®ç™»éŒ²](https://www.mapbox.com/access/isochrones-depart-at)ãŒå¿…è¦ã§ã™ã€‚

`depart_at`æ©Ÿèƒ½ã®è©³ç´°ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®ãƒ–ãƒ­ã‚°ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

https://www.mapbox.jp/blog/isochrones-depart-at


# Isochrone APIã¨ã¯
Isochrone APIã¯ã‚ã‚‹åœ°ç‚¹ã‹ã‚‰â—¯â—¯åˆ†ã§åˆ°é”ã§ãã‚‹é ˜åŸŸã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã‚‹APIã§ã™ã€‚ä¾‹ãˆã°ã€æ±äº¬é§…ã‚’ä¸­å¿ƒã«è‡ªå‹•è»Šã§5åˆ†ã§åˆ°é”ã§ãã‚‹å ´æ‰€ã¨ã„ã£ãŸæƒ…å ±ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚

# ä½œæˆã™ã‚‹ã‚‚ã®
æ±äº¬é§…ã‚’ä¸­å¿ƒã«ã€è‡ªå‹•è»Šã§5åˆ†ã€10åˆ†ã€15åˆ†ã§åˆ°é”ã§ãã‚‹ç¯„å›²ã‚’ãƒãƒªã‚´ãƒ³ã§æç”»ã—ã¾ã™ã€‚ã¾ãŸã€ã‚ã‚‹ä¸€æ—¥ã®åˆå‰ï¼æ™‚ã‹ã‚‰ï¼“æ™‚é–“åˆ»ã¿ã®å¤‰åŒ–ã‚’è¦‹ãŸã„ã®ã§ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’ä½¿ã£ã¦è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚

å®Œæˆå“ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚

@[codepen](https://codepen.io/OttyLab/pen/abXEWaR)


# ã‚³ãƒ¼ãƒ‰

ã¡ã‚‡ã†ã©ã‚¿ã‚¤ãƒ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã‚µãƒ³ãƒ—ãƒ«ãŒã‚ã£ãŸã®ã§ã“ã‚Œã‚’æµç”¨ã—ã¾ã™ã€‚

https://docs.mapbox.com/mapbox-gl-js/example/timeline-animation/

ã‚³ãƒ¼ãƒ‰ã®å…¨ä½“åƒã¯å®Œæˆå“ã®JSãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

## å®šæ•°

æœ€åˆã«ã„ãã¤ã‹å®šæ•°ã‚’å®šç¾©ã—ã¾ã™ã€‚`center`ã¯åœ°å›³ãŠã‚ˆã³Isochroneã®ä¸­å¿ƒåº§æ¨™ã§ã™ã€‚`departures`ã¯`depart_at`ã«ä½¿ç”¨ã™ã‚‹æ—¥æ™‚ã§ã™ã€‚`minutes`ã¯`contours_minutes`ã§ä½¿ç”¨ã™ã‚‹æ™‚é–“ã§ã™ã€‚

```JavaScript
const center = [139.7668267, 35.6807286];

const departures = [
  "2023-12-03T00:00",
  "2023-12-03T03:00",
  "2023-12-03T06:00",
  "2023-12-03T09:00",
  "2023-12-03T12:00",
  "2023-12-03T15:00",
  "2023-12-03T18:00",
  "2023-12-03T21:00"
];

const minutes = [5, 10, 15];
```

## ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
`getLayerId`ã¯æ—¥æ™‚ã¨æ™‚é–“ã‹ã‚‰ä¸€æ„ãªãƒ¬ã‚¤ãƒ¤ãƒ¼IDã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ã§ã™ã€‚

```JavaScript
function getLayerId(departure, minute) {
  return departure + "-" + minute;
}
```

`filterBy`ã¯ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§é¸æŠã•ã‚ŒãŸæ—¥æ™‚ã«è©²å½“ã™ã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã¿ã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ã™ã‚‹é–¢æ•°ã§ã™ã€‚Isochroneã§å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒãƒªã‚´ãƒ³ã‚’ä½œæˆã—ã¾ã™ãŒã€ãƒ¬ã‚¤ãƒ¤ãƒ¼IDãŒã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§é¸æŠã•ã‚ŒãŸæ—¥æ™‚ã®ã‚‚ã®ã ã‘ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚

```JavaScript
function filterBy(index) {
  departures.forEach((departure) => {
    minutes.forEach((minute) => {
      const visible = getLayerId(departures[index], minute);
      const id = getLayerId(departure, minute);
      map.setFilter(id, visible === id);
    });
  });

  document.getElementById("departure").textContent = departures[index];
}
```

## åœ°å›³ã®è¡¨ç¤º

ã„ã¤ã‚‚é€šã‚Šã€Mapã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã¾ã™ã€‚`container`ã§åœ°å›³ã‚’è¡¨ç¤ºã™ã‚‹HTMLã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã®idã‚’æŒ‡å®šã—ã¾ã™ã€‚

```JavaScript
const map = new mapboxgl.Map({
  container: "map",
  style: "mapbox://styles/mapbox/light-v11",
  center,
  zoom: 10
});
```

## ã‚½ãƒ¼ã‚¹ãƒ»ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä½œæˆ
`map.on("load", () => {/*ã“ã“*/});`ã®ä¸­ã§ã‚½ãƒ¼ã‚¹åŠã³ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚

### Isochone APIã‚¢ã‚¯ã‚»ã‚¹

3æ™‚é–“æ¯ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã®ã§`Promise.all`ã§åŒæ™‚ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚APIã‚¢ã‚¯ã‚»ã‚¹ã®ãŸã‚ã®URLã®çµ„ã¿ç«‹ã¦æ–¹ã¯[APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.mapbox.com/api/navigation/isochrone/#retrieve-isochrones-around-a-location)ã‚’ã”å‚ç…§ãã ã•ã„ã€‚ä»Šå›è¿½åŠ ã•ã‚ŒãŸã®ã¯`depart_at`ã®éƒ¨åˆ†ã§ã™ã€‚

```JavaScript
const tasks = departures.map(async (departure) => {
  return fetch(
    `https://api.mapbox.com/isochrone/v1/mapbox/driving/${center}?contours_minutes=${minutes.join(
      ","
    )}&contours_colors=6706ce,04e813,4286f4&polygons=true&depart_at=${departure}&access_token=${
      mapboxgl.accessToken
    }`
  );
});

const responses = await Promise.all(tasks);
```

### å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ç”¨ã„ã¦ã‚½ãƒ¼ã‚¹ãƒ»ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä½œæˆ

`responses.map(async (response) => {})`ã§å„`response`ã«é–¢ã—ã¦ã‚½ãƒ¼ã‚¹ã€ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä½œæˆã‚’è¡Œã„ã¾ã™ã€‚

ãƒªã‚¯ã‚¨ã‚¹ãƒˆURLã®ä¸­ã‹ã‚‰`depart_at`ã§æŒ‡å®šã—ãŸæ—¥æ™‚ã‚’æŠ½å‡ºã—ã¾ã™ã€‚
```JavaScript
const departure = response.url.match(
  /depart_at=(\d{4}-\d{2}-\d{2}T\d{2}:\d{2})/
)[1];
```

fetch APIã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ãŸã®ã§`response.json()`ã§Isochone APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®JSONã‚’å–å¾—ã§ãã¾ã™ã€‚ä¸­èº«ã¯GeoJSONãªã®ã§ãã®ã¾ã¾`addSource`ã§ã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚

```JavaScript
const features = await response.json();
map.addSource(departure, {
  type: "geojson",
  data: features
});
```

æ¬¡ã«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®GeoJSONã¯Featuresã§ä¸­ã«ã¯5åˆ†ã€10åˆ†ã€15åˆ†ã®ãƒ‡ãƒ¼ã‚¿ã«å¯¾å¿œã—ãŸPolygonãƒ‡ãƒ¼ã‚¿ãŒé…åˆ—ã¨ã—ã¦æ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ã€‚è‰²åˆ†ã‘ã™ã‚‹ãŸã‚ã«ã€ä¸€ã¤ãšã¤å–ã‚Šå‡ºã—ã¦ãã‚Œãã‚Œãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚`filter`ã®`["==", ["get", "contour"], minute]`ã¯`contour`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ï¼ˆæ™‚é–“ãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹ï¼‰ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€5åˆ†ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã¯`contour`ãŒ`5`ã§ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã™ã‚‹ã€ã¨ãªã‚Šã¾ã™ã€‚

```JavaScript
features.features.forEach((feature) => {
  const minute = feature.properties.contour;
  const id = getLayerId(departure, minute);

  map.addLayer({
    id,
    type: "fill",
    source: departure,
    filter: ["==", ["get", "contour"], minute],
    paint: {
      "fill-color": feature.properties.fillColor,
      "fill-opacity": feature.properties["fill-opacity"]
    }
  });
});
```

å‡¦ç†å…¨ä½“ã‚’`await Promise.all();`ã§ãã‚‹ã‚“ã§ã„ã‚‹ã®ã§ã€ç©ºã®`Promise`ã‚’è¿”ã—ã¾ã™ã€‚å…¨`resonpse`ã®å‡¦ç†ãŒå®Œäº†ã™ã‚‹ã®ã‚’å¾…ã¡ãŸã„ã®ã§ã“ã®å‡¦ç†ã‚’å…¥ã‚Œã¦ã„ã¾ã™ã€‚

```JavaScript
return new Promise((resolve) => {
  resolve();
});
```

### ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å®Ÿè£…

ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãŒå‹•ã‹ã•ã‚ŒãŸã¨ãã«`filterBy`ã‚’å‘¼ã³å‡ºã—ã€è©²å½“ã™ã‚‹æ—¥æ™‚ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã ã‘ã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ã¾ãŸã€èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«è‡ªå‹•çš„ã«0ç•ªç›®ã‚’è¡¨ç¤ºã—ãŸã„ã®ã§`filterBy(0)`ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã“ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã™ã¹ã¦ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä½œæˆãŒå®Œäº†ã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã£ãŸã®ã§å…ˆç¨‹ç©ºã®`Promise`ã‚’ä½œæˆã—ã¦ã„ã¾ã—ãŸã€‚

```JavaScript
document.getElementById("slider").addEventListener("input", (e) => {
  filterBy(parseInt(e.target.value, departures.length));
});

filterBy(0);
```

# ã¾ã¨ã‚

æ—¥ä¸­ã¯é“è·¯ãŒæ··ã‚“ã§ã„ã‚‹ã®ã§åˆ°é”ã§ãã‚‹ç¯„å›²ãŒå°ã•ããªã£ã¦ã„ã‚‹æ§˜å­ãŒã‚ã‹ã‚Šã¾ã™ã€‚