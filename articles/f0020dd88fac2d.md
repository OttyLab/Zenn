---
title: "Mapbox Newsletter WEEKLY TIPSã®è§£èª¬ -ã€Œ3Dãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ ã€"
emoji: "ğŸ•’"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Mapbox", "MapboxGLJS", "GIS", "JavaScript"]
published: false
publication_name: "mapbox_japan"
---

# ã¯ã˜ã‚ã«

ã“ã®è¨˜äº‹ã¯ã€å…ˆæ—¥é…ä¿¡ã•ã‚ŒãŸMapbox Newsletterã®WEEKLY TIPSã§ç´¹ä»‹ã•ã‚Œã¦ã„ãŸã€Œ3Dãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ ã€ã«ã¤ã„ã¦ã®è§£èª¬ã§ã™ã€‚ã“ã®ã‚µãƒ³ãƒ—ãƒ«ã§ã¯[Three.js](https://threejs.org/)ã‚’ä½¿ã£ã¦[`CustomLayerInterface`](https://docs.mapbox.com/mapbox-gl-js/api/properties/#customlayerinterface)ã‚’æ§‹æˆã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¦ã„ã¾ã™ã€‚ã¾ãŸã€Newsletterã®è³¼èª­ã¯[ã“ã¡ã‚‰](https://www.mapbox.jp/blog?#:~:text=%E3%83%8B%E3%83%A5%E3%83%BC%E3%82%B9%E3%83%AC%E3%82%BF%E3%83%BC%E3%82%92%E8%B3%BC%E8%AA%AD)ã‹ã‚‰ãŠç”³ã—è¾¼ã¿ã„ãŸã ã‘ã¾ã™ã€‚

ä»¥ä¸‹ãŒæœ¬ã‚µãƒ³ãƒ—ãƒ«ã®ãƒ‡ãƒ¢ã§ã™ã€‚

@[codepen](https://codepen.io/OttyLab/pen/YzMGVPE)


# Three.jsã¨ã¯
[Three.js](https://threejs.org/)ã¯WebGLãƒ™ãƒ¼ã‚¹ã®3Dãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚[ã€Œã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ ã€](https://zenn.dev/mapbox_japan/articles/7a48c93b0d2444)ã§ã¯WebGLã‚’ç›´æ¥ä½¿ã£ã¦ã‚«ã‚¹ã‚¿ãƒ ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½œæˆã—ã¦ã„ã¾ã—ãŸãŒã€ä¸€ã¤ã®ä¸‰è§’å½¢ã‚’æãã®ã«ã‚‚ã‹ãªã‚Šã®é‡ã®ã‚³ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã—ãŸã€‚Three.jsã‚’ä½¿ã†ã“ã¨ã§ã€ã‚ˆã‚Šä¾¿åˆ©ã«ã‚«ã‚¹ã‚¿ãƒ ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚


# ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèª

ã¾ãšExamplesã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã«è¡Œãã¾ã—ã‚‡ã†ã€‚

æ—¥æœ¬èªã‚µã‚¤ãƒˆ
@[card](https://docs.mapbox.com/jp/mapbox-gl-js/example/add-3d-model/)

è‹±èªã‚µã‚¤ãƒˆ
@[card](https://docs.mapbox.com/mapbox-gl-js/example/add-3d-model)

åŸºæœ¬çš„ã«åŒã˜ã‚³ãƒ¼ãƒ‰ã§ã™ãŒã€è‹±èªç‰ˆã¯ã‚¹ã‚¿ã‚¤ãƒ«ãŒMapbox Light v11ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã®ã§ã“ã¡ã‚‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚Mapbox Light v10ã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãŒWebãƒ¡ãƒ«ã‚«ãƒˆãƒ«ã§ã‚ã‚‹ã®ã«å¯¾ã—ã€Mapbox Light v11ã§ã¯Globeï¼ˆ3Dè¡¨ç¤ºã•ã‚ŒãŸåœ°çƒï¼‰ãªã®ã§ã€å°è±¡ãŒã‹ãªã‚Šç•°ãªã‚Šã¾ã™ã€‚ã¾ãŸã€è‹±èªç‰ˆã¯Mapbox GL JS v3ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

## HTML

ã¾ãšHTMLã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚


ä»¥ä¸‹ã§ã¯Three.jsã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™ã€‚é€”ä¸­ã€glTFå½¢å¼ã®3Dãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã‚€ãŸã‚ã€addonã®`GLTFLoader.js`ã‚‚èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™ã€‚
```HTML
<script src="https://unpkg.com/three@0.126.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.126.0/examples/js/loaders/GLTFLoader.js"></script>
```

ä»¥ä¸‹ã¯åœ°å›³ã‚’è¡¨ç¤ºã™ã‚‹ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã§ã™ã€‚

```HTML
<div id="map"></div>
```

## Mapã®ä½œæˆ

JavaScriptã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¯ã„ã¤ã‚‚é€šã‚Šã€Mapã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚`container`ã§åœ°å›³ã‚’è¡¨ç¤ºã™ã‚‹HTMLã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã®idã‚’æŒ‡å®šã—ã¾ã™ã€‚

```JavaScript
const map = new mapboxgl.Map({
   container: 'map',
   // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
   style: 'mapbox://styles/mapbox/light-v11',
   zoom: 18,
   center: [148.9819, -35.3981],
   pitch: 60,
   antialias: true // create the gl context with MSAA antialiasing, so custom layers are antialiased
});
```

## 3Dãƒ¢ãƒ‡ãƒ«ã®ãŸã‚ã®è¨­å®š

å¾Œã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å…ˆã«ä½œæˆã—ã¦ã„ã¾ã™ã€‚

3Dãƒ¢ãƒ‡ãƒ«ã‚’é…ç½®ã™ã‚‹åº§æ¨™ã€é«˜åº¦ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚
```JavaScript
// parameters to ensure the model is georeferenced correctly on the map
const modelOrigin = [148.9819, -35.39847];
const modelAltitude = 0;
```

WebGLã§ã¯PCã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³æ¨ªæ–¹å‘ãŒXè»¸ã€ç¸¦æ–¹å‘ãŒYè»¸ã€ç”»é¢æ‰‹å‰æ–¹å‘ãŒZè»¸ã§ã™ã€‚[ä»Šå›ä½¿ç”¨ã™ã‚‹ï¼“Dãƒ¢ãƒ‡ãƒ«](https://docs.mapbox.com/mapbox-gl-js/assets/34M_17/34M_17.gltf)ã¯Yè»¸ãŒä¸Šã«ãªã‚Šã¾ã™ã€‚ã—ã‹ã—ã€åœ°å›³ã¯çœŸä¸Šã‹ã‚‰è¦‹ã‚‹ç‰©ãªã®ã§ã€ä¸Šã¯Zè»¸æ–¹å‘ã«ãªã‚Šã¾ã™ã€‚ãã“ã§Xè»¸ã§90åº¦å›è»¢ã•ã›ã¾ã™ã€‚
```JavaScript
const modelRotate = [Math.PI / 2, 0, 0];
```

åº§æ¨™ã¨æ¨™é«˜ã‹ã‚‰ã€WebGLä¸Šã§ã®åº§æ¨™ã‚’è¨ˆç®—ã—ã¾ã™ã€‚
```JavaScript
const modelAsMercatorCoordinate = mapboxgl.MercatorCoordinate.fromLngLat(
  modelOrigin,
  modelAltitude
);
```

ä»¥ä¸Šã®å€¤ã‚’å¾Œã§ä½¿ã„ã‚„ã™ã„å½¢ã«ã¾ã¨ã‚ã¾ã™ã€‚

```JavaScript
// transformation parameters to position, rotate and scale the 3D model onto the map
const modelTransform = {
  translateX: modelAsMercatorCoordinate.x,
  translateY: modelAsMercatorCoordinate.y,
  translateZ: modelAsMercatorCoordinate.z,
  rotateX: modelRotate[0],
  rotateY: modelRotate[1],
  rotateZ: modelRotate[2],
  /* Since the 3D model is in real world meters, a scale transform needs to be
   * applied since the CustomLayerInterface expects units in MercatorCoordinates.
   */
  scale: modelAsMercatorCoordinate.meterInMercatorCoordinateUnits()
};
```

[`MercatorCoordinate#meterInMercatorCoordinateUnits()`](https://docs.mapbox.com/mapbox-gl-js/api/geography#mercatorcoordinate#meterinmercatorcoordinateunits)ã¯ã€3Dãƒ¢ãƒ‡ãƒ«ãŒæŒ‡å®šã—ã¦ã„ã‚‹ç¾å®Ÿã®é•·ã•ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«å˜ä½ï¼‰ã‚’åœ°å›³ä¸Šã§ã®ç¸®å°ºã«å¿œã˜ãŸé•·ã•ã«å¤‰æ›ã™ã‚‹å€¤ã‚’è¨ˆç®—ã—ã¾ã™ã€‚

## Three.jsã®å–å¾—

Three.jsã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚
```
const THREE = window.THREE;
```

## ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä½œæˆ

é€”ä¸­ã‚’é£›ã°ã—ã¦æœ€å¾Œã®éƒ¨åˆ†ã‚’ç¢ºèªã—ã¾ã™ã€‚`customLayer`ã¯ã‚«ã‚¹ã‚¿ãƒ ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹å¤‰æ•°ã§ã™ã€‚Symbolãƒ¬ã‚¤ãƒ¤ãƒ¼ç­‰ã¨åŒã˜æ§˜ã«[Map#addLayer](https://docs.mapbox.com/mapbox-gl-js/api/map#map#addlayer)ãƒ¡ã‚½ãƒƒãƒ‰ã§ä½œæˆã—ã¾ã™ã€‚ç¬¬2å¼•æ•°ã«`waterway-label`ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ã®ã§ã€è‡ªä½œãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã“ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä¸‹ã«æç”»ã•ã‚Œã¾ã™ã€‚

```JavaScript
map.on('style.load', () => {
  map.addLayer(customLayer, 'waterway-label');
});
```

## ã‚«ã‚¹ã‚¿ãƒ ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å®šç¾©
ãã‚Œã§ã¯`customLayer`ã®ä¸­èº«ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

`id`ã¨`type`ã‚’æŒ‡å®šã™ã‚‹ã®ã¯ä»–ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨åŒã˜ã§ã™ã€‚`CustomLayerInterface`ã®ã¨ãã¯`custom`ã‚’æŒ‡å®šã—ã¾ã™ã€‚ã¾ãŸã€3Dãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã®ã§`renderingMode`ã«`3d`ã‚’æŒ‡å®šã—ã¾ã™ã€‚

```JavaScript
id: 'customLayer',
type: 'custom',
renderingMode: '3d',
```

`renderingMode`ã¯æ·±åº¦ãƒãƒƒãƒ•ã‚¡ã®åˆ¶å¾¡ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ä¸‹å›³ã®ã‚ˆã†ã«ã€`3d`ã«è¨­å®šã™ã‚‹ã¨æ·±åº¦ãƒãƒƒãƒ•ã‚¡ã‚’ç”¨ã„ã¦3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é‡ãªã‚ŠãŒæ­£ã—ãæç”»ã•ã‚Œã¾ã™ãŒã€`2d`ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ã®å ´åˆã¯æ­£ã—ãæç”»ã•ã‚Œã¾ã›ã‚“ã€‚

|`3d`|`2d`|
|:--:|:--:|
|![3d](/images/articles/f0020dd88fac2d/3d.png)|![2d](/images/articles/f0020dd88fac2d/2d.png)|

### onAdd
ä»¥ä¸‹ã®`onAdd`ã®ä¸­èº«ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

```JavaScript
onAdd: function (map, gl) {
  ...
},
```

ã¾ãšã€Three.jsã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã‚ã‚‹ã‚«ãƒ¡ãƒ©ã¨ã‚·ãƒ¼ãƒ³ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚
```JavaScript
this.camera = new THREE.Camera();
this.scene = new THREE.Scene();
```

æŒ‡å‘æ€§ãƒ©ã‚¤ãƒˆã‚’2ã¤ä½œæˆã—ã¦ã„ã¾ã™ã€‚æ–œã‚ä¸Šä¸‹ã‹ã‚‰å…‰ã‚’å½“ã¦ã¦ã„ã¾ã™ã€‚

```JavaScript
// create two three.js lights to illuminate the model
const directionalLight = new THREE.DirectionalLight(0xffffff);
directionalLight.position.set(0, -70, 100).normalize();
this.scene.add(directionalLight);

const directionalLight2 = new THREE.DirectionalLight(0xffffff);
directionalLight2.position.set(0, 70, 100).normalize();
this.scene.add(directionalLight2);
```

glTFã®3Dãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™ã€‚

```JavaScript
const loader = new THREE.GLTFLoader();
loader.load(
  'https://docs.mapbox.com/mapbox-gl-js/assets/34M_17/34M_17.gltf',
  (gltf) => {
    this.scene.add(gltf.scene);
  }
);
```

æœ€å¾Œã«Three.jsã®ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚`autoClear`ã‚’`false`ã«ã—ã¦ãŠã‹ãªã„ã¨ã€åœ°å›³ãŒæ­£ã—ãæç”»ã•ã‚Œã¾ã›ã‚“ã€‚

```JavaScript
this.renderer = new THREE.WebGLRenderer({
  canvas: map.getCanvas(),
  context: gl,
  antialias: true
});

this.renderer.autoClear = false;
```

### render
ä»¥ä¸‹ã®`render`ã®ä¸­èº«ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

```JavaScript
render: function (gl, matrix) {
  ...
}
```

`modelRotate`ã§å®šç¾©ã—ãŸå€¤ã‚’ä½¿ã£ã¦ã€å„è»¸ã«ãŠã‘ã‚‹å›è»¢è¡Œåˆ—ã‚’ä½œæˆã—ã¾ã™ã€‚

```JavaScript
const rotationX = new THREE.Matrix4().makeRotationAxis(
  new THREE.Vector3(1, 0, 0),
  modelTransform.rotateX
);
const rotationY = new THREE.Matrix4().makeRotationAxis(
  new THREE.Vector3(0, 1, 0),
  modelTransform.rotateY
);
const rotationZ = new THREE.Matrix4().makeRotationAxis(
  new THREE.Vector3(0, 0, 1),
  modelTransform.rotateZ
);
```

Mapbox GL JSã®ã‚«ãƒ¡ãƒ©è¡Œåˆ—(`m`)ã¨ã€åº§æ¨™å¤‰æ›è¡Œåˆ—(`l`)ã‹ã‚‰ã€Three.jsã®ã‚«ãƒ¡ãƒ©è¡Œåˆ—ã‚’è¨ˆç®—ã—ã¾ã™ã€‚
```JavaScript
const m = new THREE.Matrix4().fromArray(matrix);
const l = new THREE.Matrix4()
  .makeTranslation(
    modelTransform.translateX,
    modelTransform.translateY,
    modelTransform.translateZ
  )
  .scale(
    new THREE.Vector3(
      modelTransform.scale,
      -modelTransform.scale,
      modelTransform.scale
    )
  )
  .multiply(rotationX)
  .multiply(rotationY)
  .multiply(rotationZ);

this.camera.projectionMatrix = m.multiply(l);
```

æœ€å¾Œã«æç”»å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚è¤‡æ•°ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§WebGLã‚’å…±æœ‰ã—ã¦ã„ã‚‹ã¨ãã¯`resetState`ã‚’å‘¼ã¶å¿…è¦ãŒã‚ã‚‹ã‚ˆã†ã§ã™ã€‚ã¾ãŸã€`triggerRepaint`ã‚’å®Ÿè¡Œã—ãªã„ã¨ã€glTFãƒ­ãƒ¼ãƒ‰å¾Œã«3Dãƒ¢ãƒ‡ãƒ«ãŒæç”»ã•ã‚Œã¾ã›ã‚“ã€‚
```JavaScript
this.renderer.resetState();
this.renderer.render(this.scene, this.camera);
this.map.triggerRepaint();
```


# ã¾ã¨ã‚
Three.jsã‚’ä½¿ã†ã“ã¨ã§ã€è¤‡é›‘ãª3Dãƒ¢ãƒ‡ãƒ«ã‚‚è¡¨ç¤ºã§ãã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚
