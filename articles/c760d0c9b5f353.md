---
title: "Symbol Layerã®ã‚¢ã‚¤ã‚³ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§Popupã‚’è¡¨ç¤ºã™ã‚‹"
emoji: "ğŸ’¬"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Mapbox", "MapboxGLJS", "GIS", "JavaScript"]
published: true
publication_name: "mapbox_japan"
---

# ã¯ã˜ã‚ã«

[ã“ã®è¨˜äº‹](TBD)ã§ã¯Markerã¨Popupã‚’é€£å‹•ã•ã›ã‚‹æ–¹æ³•ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã—ãŸã€‚ä¸€æ–¹ã§ã€[Pinã®è¡¨ç¤ºæ–¹æ³•ã¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨Markerã©ã¡ã‚‰ã‚’ä½¿ã†ã®ãŒã‚ˆã„ï¼Ÿ](https://zenn.dev/mapbox_japan/articles/b05d528a9b27f6)ã§ã¯è¡¨ç¤ºã™ã‚‹ãƒã‚¤ãƒ³ãƒˆã®æ•°ãŒå¤šã„ã¨ãã«ã¯MarkerãŒé©ã—ã¦ãªã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚ãã“ã§ã“ã®è¨˜äº‹ã§ã¯ãƒã‚¤ãƒ³ãƒˆã®æ•°ãŒå¤šã„ã¨ãã«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½¿ã£ã¦Popupã¨é€£æºã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚

# ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨Popupã®é€£æº

ã‚µãƒ¼ã‚¯ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚„ã‚·ãƒ³ãƒœãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§è¡¨ç¾ã•ã‚Œã¦ã„ã‚‹ãƒã‚¤ãƒ³ãƒˆã¯ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’æŒã¡ã¾ã›ã‚“ã€‚ã¤ã¾ã‚Šã€å˜ä½“ã§ã¯ãã®ãƒã‚¤ãƒ³ãƒˆãŒã‚¯ãƒªãƒƒã‚¯ã§ããŸã‹ã©ã†ã‹ã‚’çŸ¥ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ãã“ã§ã€`queryRenderedFeatures`ã‚’ã¤ã‹ã£ã¦ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´æ‰€ã‚’æ¤œç´¢ã—ã€ãƒã‚¤ãƒ³ãƒˆã‚’è¡¨ç¾ã—ã¦ã„ã‚‹FeatureãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã«Popupã‚’è¡¨ç¤ºã™ã‚‹ã¨ã„ã†æ–¹æ³•ã§ä»£æ›¿ã—ã¾ã™ã€‚

## queryRenderedFeaturesã¨ã¯

Mapbox GL GSï¼ˆãŠã‚ˆã³ãƒ¢ãƒã‚¤ãƒ«SDKï¼‰ã«ã¯[`queryRenderedFeatures`](https://docs.mapbox.com/mapbox-gl-js/api/map/#map#queryrenderedfeatures)ã¨ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯æŒ‡å®šã—ãŸãƒã‚¤ãƒ³ãƒˆã‚„é ˜åŸŸï¼ˆBounding Boxï¼‰ã«å¯¾ã—ã€åœ°å›³ä¸Šã®Featureã‚’æ¤œç´¢ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚ä¾‹ãˆã°é“è·¯ä¸Šã®ãƒã‚¤ãƒ³ãƒˆã«å¯¾ã—ã¦å®Ÿè¡Œã™ã‚‹ã¨ã€é“è·¯ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«é–¢ã™ã‚‹æƒ…å ±ãŒå–å¾—ã§ãã¾ã™ã€‚


# ä½¿ç”¨ã™ã‚‹ã‚³ãƒ¼ãƒ‰

ä»¥å‰ä½œæˆã—ãŸä»¥ä¸‹ã®Party Parrotã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

@[codepen](https://codepen.io/OttyLab/pen/QWZPJMj)

ã‚³ãƒ¼ãƒ‰ã®è§£èª¬ã¯ä»¥ä¸‹ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

@[card](https://zenn.dev/mapbox_japan/articles/e8702cb8d3ec0e)


# å®Ÿè£…

`load`ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®ä¸€ç•ªæœ€å¾Œã®éƒ¨åˆ†ã«ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’æŒ¿å…¥ã—ã¾ã™ã€‚

```JavaScript
map.on("load", () => {
  ...ä¸­ç•¥...
  map.on("click", (e) => {
    const result = map.queryRenderedFeatures(e.point, { layers: ["parrot"] });

    if (result.length === 0) {
      return;
    }

    const popup = new mapboxgl.Popup({ offset: 20 })
      .setLngLat(e.lngLat)
      .setText(result[0].properties.name)
      .addTo(map);
  });
});
```

`queryRenderedFeatures`ã®ç¬¬ä¸€å¼•æ•°ã«æ¤œç´¢ã™ã‚‹å ´æ‰€ã€ç¬¬äºŒå¼•æ•°ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¾ã™ã€‚ã“ã“ã§ã¯`parrot`ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã¿ã‚’æ¤œç´¢ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚ä½•ã‚‚ãªã‘ã‚Œã°ç©ºé…åˆ—ãŒè¿”ã£ã¦ãã‚‹ã®ã§`length`ã§ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã¾ã™ã€‚æ¤œå‡ºã•ã‚ŒãŸå ´åˆã«ã¯ï¼‘ã¤ç›®ã®`name`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’Popupã¨ã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚

çµæœã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚

@[codepen](https://codepen.io/OttyLab/pen/mdzNNKg)


# Popupã¯ã©ã®ã‚ˆã†ã«ç®¡ç†ã•ã‚Œã¦ã„ã‚‹ã‹

ãƒã‚¤ãƒ³ãƒˆã®æ•°ãŒå¢—ãˆãŸã¨ãã«Popupã®æ•°ãŒãã‚Œã«å¿œã˜ã¦å¢—ãˆã‚‹ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æ‡¸å¿µãŒç”Ÿã˜ã¾ã™ã€‚ãã“ã§ã€ã©ã®ã‚ˆã†ã«PopupãŒç®¡ç†ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãŠãã¾ã™ã€‚

ã¾ãšã€`addTo`ã®ä¸­ã§[Mapã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ ã™ã‚‹å‡¦ç†](https://github.com/mapbox/mapbox-gl-js/blob/v2.15.0/src/ui/popup.js#L158)ãŒè¡Œã‚ã‚Œã¾ã™ã€‚`_addPopup`ãŒè¡Œã†å‡¦ç†ã¯Mapã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒç®¡ç†ã™ã‚‹Popupé…åˆ—ã¸ã®[Popupã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®è¿½åŠ ](https://github.com/mapbox/mapbox-gl-js/blob/v2.15.0/src/ui/map.js#L2984)ã§ã™ã€‚ã¾ãŸã€PopupãŒéè¡¨ç¤ºã«ãªã‚‹éš›ã€[`_onClsoe`](https://github.com/mapbox/mapbox-gl-js/blob/v2.15.0/src/ui/popup.js#L672)ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ã“ã“ã§[`remove`](https://github.com/mapbox/mapbox-gl-js/blob/v2.15.0/src/ui/popup.js#L215)ãŒå®Ÿè¡Œã•ã‚Œã€ä½œæˆã—ãŸã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã®å‰Šé™¤ï¼ˆ[content](https://github.com/mapbox/mapbox-gl-js/blob/v2.15.0/src/ui/popup.js#L217)ã€[container](https://github.com/mapbox/mapbox-gl-js/blob/v2.15.0/src/ui/popup.js#L221)ï¼‰ãŠã‚ˆã³Mapã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®[é…åˆ—ã‹ã‚‰ã®å‰Šé™¤](https://github.com/mapbox/mapbox-gl-js/blob/v2.15.0/src/ui/popup.js#L246)ãŒè¡Œã‚ã‚Œã¾ã™ã€‚

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯`closeOnClick`ãŒ`true`ãªã®ã§ã€Popupå¤–ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã‚‹ã¨PopupãŒæ¶ˆãˆã¾ã™ã€‚ã“ã‚Œã¯åœ°å›³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ­£ç¢ºã«ã¯`preclick`ã‚¤ãƒ™ãƒ³ãƒˆï¼‰ã«`_onClose`ã®å®Ÿè¡Œã‚’å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ã§[å®Ÿç¾](https://github.com/mapbox/mapbox-gl-js/blob/v2.15.0/src/ui/popup.js#L145-L148)ã—ã¦ã„ã¾ã™ã€‚ã¤ã¾ã‚Šã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯Popupã¯å¸¸ã«æœ€å¤§1å€‹ã—ã‹è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚

ä»¥ä¸Šã‚ˆã‚Šã€ä¸€ã¤ã®Popupã‚’è¡¨ç¤ºã™ã‚‹ã¨ç¾åœ¨è¡¨ç¤ºã•ã‚Œã‚‹Popupã¯éè¡¨ç¤ºã¨ãªã‚Šã¾ã™ã€‚ãã®éš›ã€HTMLã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚Œã€Mapã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ã‚‚é–‹æ”¾ã•ã‚Œã‚‹ãŸã‚ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«å½±éŸ¿ã‚’åŠã¼ã™ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãŸã ã—ã€`closeOnClick: false`ã¨ã—ãŸå ´åˆã‚„ã‚³ãƒ¼ãƒ‰ã‹ã‚‰Popupã‚’è¤‡æ•°ä½œæˆã—ãŸå ´åˆã«ã¯ã€åŒæ™‚ã«è¤‡æ•°ã®Popupã‚’é–‹ã„ãŸçŠ¶æ…‹ã«ã§ãã‚‹ãŸã‚å¤§é‡ã«è¡¨ç¤ºã™ã‚‹ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä¸Šã®æ‡¸å¿µãŒã‚ã‚Šã¾ã™ã€‚


# ãƒ¬ã‚¤ãƒ¤ãƒ¼IDã‚’æŒ‡å®šã—ãŸã‚¤ãƒ™ãƒ³ãƒˆ

`Map`ã‚¯ãƒ©ã‚¹ã®`on`ãƒ¡ã‚½ãƒƒãƒ‰ã«ã¯ãƒ¬ã‚¤ãƒ¤ãƒ¼IDã‚’ç¬¬äºŒå¼•æ•°ã«æŒ‡å®šã™ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™ã€‚`click`ã‚¤ãƒ™ãƒ³ãƒˆã«ãŠã„ã¦ç¬¬äºŒå¼•æ•°ã‚’æŒ‡å®šã™ã‚‹ã¨ã€ã‚¯ãƒªãƒƒã‚¯ã—ãŸãƒã‚¤ãƒ³ãƒˆã«ãã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ã¨ãã®ã¿ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå‘¼ã°ã‚Œã¾ã™ã€‚ã•ã‚‰ã«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã®å¼•æ•°ã®`features`ã«`queryRenderedFeatures`ã®çµæœãŒæ ¼ç´ã•ã‚ŒãŸçŠ¶æ…‹ã¨ãªã‚Šã¾ã™ã€‚è©³ç´°ã¯[ã“ã¡ã‚‰](https://docs.mapbox.com/mapbox-gl-js/api/map/#map.event:click)ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

ãã®ãŸã‚ã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç†ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã€ã‚ˆã‚Šç°¡æ½”ã«è¨˜è¿°ã§ãã¾ã™ã€‚

```JavaScript
map.on("click", "parrot", (e) => {
  const popup = new mapboxgl.Popup({ offset: 20 })
    .setLngLat(e.lngLat)
    .setText(e.features[0].properties.name)
    .addTo(map);
});
```

çµæœã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚

@[codepen](https://codepen.io/OttyLab/pen/jOQrQPJ)


# ã‚„ã£ã±ã‚Šã‚‚ã£ã¨Party!

ãƒã‚¤ãƒ³ãƒˆæ•°ãŒå¢—ãˆã¦ã‚‚å¤§ä¸ˆå¤«ã§ã™ã€‚

@[codepen](https://codepen.io/OttyLab/pen/oNQvNGB)


# ã¾ã¨ã‚

ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å¯¾ã—ã¦Popupã‚’ä½¿ç”¨ã§ãã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚ã“ã‚Œã§çŠ¶æ³ã«å¿œã˜ã¦Marker+Popupã€ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‹PopupãŒä½¿ã„åˆ†ã‘ã‚‰ã‚Œãã†ã§ã™ã€‚ã¾ãŸã€ä¼¼ãŸã‚ˆã†ãªãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ãŒãƒ¢ãƒã‚¤ãƒ«SDKã§ã‚‚ä½¿ç”¨å¯èƒ½ã§ã™ã€‚ãƒ¢ãƒã‚¤ãƒ«SDKã«ã¯PopupãŒãªã„ãŸã‚ã€View Annotationã‚’ä½¿ç”¨ã—ã¾ã™ã€‚è©³ç´°ã¯ä»¥ä¸‹ã®Exampleã‚’ã”å‚ç…§ãã ã•ã„ã€‚

Android:
https://docs.mapbox.com/android/maps/examples/view-annotation-showcase/

iOS:
https://docs.mapbox.com/ios/maps/examples/view-annotation-marker/
